name: OCI A1 capacity hunter

on:
  workflow_dispatch:
    inputs:
      started_at:
        description: 'Unix timestamp when this retry chain started (internal, do not touch)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  create-a1:
    runs-on: ubuntu-latest

    env:
      OCI_TENANCY_OCID: ${{ secrets.OCI_TENANCY_OCID }}
      OCI_USER_OCID: ${{ secrets.OCI_USER_OCID }}
      OCI_REGION: ${{ secrets.OCI_REGION }}
      OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
      OCI_PRIVATE_KEY: ${{ secrets.OCI_PRIVATE_KEY }}

      OCI_COMPARTMENT_OCID: ${{ secrets.OCI_COMPARTMENT_OCID }}
      OCI_SUBNET_OCID: ${{ secrets.OCI_SUBNET_OCID }}
      OCI_IMAGE_OCID: ${{ secrets.OCI_IMAGE_OCID }}
      OCI_AD_INDEX: ${{ secrets.OCI_AD_INDEX }}

      # Optional; defaults applied in steps if not set
      OCI_INSTANCE_NAME: ${{ secrets.OCI_INSTANCE_NAME }}
      OCI_A1_OCPUS: ${{ secrets.OCI_A1_OCPUS }}
      OCI_A1_MEMORY_GB: ${{ secrets.OCI_A1_MEMORY_GB }}
      OCI_A1_BOOT_GB: ${{ secrets.OCI_A1_BOOT_GB }}

      # Public key you generated on your PC
      SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}

      OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING: "True"

      GH_PAT: ${{ secrets.GH_PAT }}

    steps:
      - name: Set up OCI config and key
        shell: bash
        run: |
          set -euo pipefail
          : "${OCI_INSTANCE_NAME:=cloud-laptop}"
          : "${OCI_A1_OCPUS:=4}"
          : "${OCI_A1_MEMORY_GB:=24}"
          : "${OCI_A1_BOOT_GB:=200}"

          mkdir -p "$HOME/.oci"
          printf '%s\n' "$OCI_PRIVATE_KEY" > "$HOME/.oci/oci_api_key.pem"
          chmod 600 "$HOME/.oci/oci_api_key.pem"

          cat > "$HOME/.oci/config" <<EOF
          [DEFAULT]
          user=$OCI_USER_OCID
          fingerprint=$OCI_FINGERPRINT
          tenancy=$OCI_TENANCY_OCID
          region=$OCI_REGION
          key_file=$HOME/.oci/oci_api_key.pem
          EOF
          chmod 600 "$HOME/.oci/config"

      - name: Install OCI CLI via pip
        shell: bash
        run: |
          set -euo pipefail
          python3 -m pip install --user --upgrade oci-cli
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Single A1 capacity check + launch attempt
        id: main
        shell: bash
        run: |
          set -euo pipefail

          # Chain start tracking (for 4h window)
          STARTED_AT_INPUT="${{ github.event.inputs.started_at }}"
          if [ -z "$STARTED_AT_INPUT" ]; then
            CHAIN_STARTED_AT=$(date -u +%s)
            echo "No chain start passed; starting new chain at $CHAIN_STARTED_AT"
          else
            CHAIN_STARTED_AT="$STARTED_AT_INPUT"
            echo "Continuing existing chain started at $CHAIN_STARTED_AT"
          fi
          echo "chain_started_at=$CHAIN_STARTED_AT" >> "$GITHUB_OUTPUT"

          : "${OCI_INSTANCE_NAME:=cloud-laptop}"
          : "${OCI_A1_OCPUS:=4}"
          : "${OCI_A1_MEMORY_GB:=24}"
          : "${OCI_A1_BOOT_GB:=200}"

          if [ -z "${SSH_PUBLIC_KEY:-}" ]; then
            summary="SSH_PUBLIC_KEY secret is not set; cannot proceed."
            echo "$summary"
            echo "result=error" >> "$GITHUB_OUTPUT"
            echo "summary=$summary" >> "$GITHUB_OUTPUT"
            echo "ssh_public_key=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Prepare SSH public key
          mkdir -p "$HOME/.ssh"
          SSH_PUB="$HOME/.ssh/oci_cloud_laptop.pub"
          printf '%s\n' "$SSH_PUBLIC_KEY" | head -n 1 | sed 's/\r$//' > "$SSH_PUB"
          chmod 600 "$SSH_PUB"

          # Validate key
          if ! ssh-keygen -l -f "$SSH_PUB" >/dev/null 2>&1; then
            summary="SSH_PUBLIC_KEY is not a valid OpenSSH public key (ssh-keygen -l failed)."
            echo "$summary"
            echo "result=error" >> "$GITHUB_OUTPUT"
            echo "summary=$summary" >> "$GITHUB_OUTPUT"
            echo "ssh_public_key=$(cat "$SSH_PUB")" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Using SSH public key:"
          ssh-keygen -l -f "$SSH_PUB"
          echo "ssh_public_key=$(cat "$SSH_PUB")" >> "$GITHUB_OUTPUT"

          echo "Checking if instance '$OCI_INSTANCE_NAME' already exists..."
          existing_json=$(oci compute instance list \
            --compartment-id "$OCI_COMPARTMENT_OCID" \
            --display-name "$OCI_INSTANCE_NAME" \
            --all)

          existing_id=$(echo "$existing_json" | jq -r '.data[]
            | select(."lifecycle-state" != "TERMINATED")
            | .id' | head -n 1 || true)

          if [ -n "$existing_id" ]; then
            summary="Instance '$OCI_INSTANCE_NAME' already exists (OCID: $existing_id); no action."
            echo "$summary"
            echo "result=already-exists" >> "$GITHUB_OUTPUT"
            echo "summary=$summary" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "No existing instance. Will try to launch new A1 instance..."

          ad_list=$(oci iam availability-domain list --compartment-id "$OCI_TENANCY_OCID")
          AD_NAME=$(echo "$ad_list" | jq -r ".data[$OCI_AD_INDEX].name" || echo "")
          if [ -z "$AD_NAME" ] || [ "$AD_NAME" = "null" ]; then
            summary="Config error: failed to determine AD name for index $OCI_AD_INDEX."
            echo "$summary"
            echo "result=error" >> "$GITHUB_OUTPUT"
            echo "summary=$summary" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "Using AD: $AD_NAME"

          TEMPL_DIR="$HOME/oci-templates"
          mkdir -p "$TEMPL_DIR"
          cat > "$TEMPL_DIR/instanceOptions.json" <<EOF
          {
            "areLegacyImdsEndpointsDisabled": false
          }
          EOF
          cat > "$TEMPL_DIR/shapeConfig.json" <<EOF
          {
            "ocpus": $OCI_A1_OCPUS,
            "memoryInGBs": $OCI_A1_MEMORY_GB
          }
          EOF
          cat > "$TEMPL_DIR/availabilityConfig.json" <<EOF
          {
            "recoveryAction": "RESTORE_INSTANCE"
          }
          EOF

          echo "Attempting to launch instance..."
          set +e
          launch_output=$(oci compute instance launch \
            --availability-domain "$AD_NAME" \
            --compartment-id "$OCI_COMPARTMENT_OCID" \
            --shape VM.Standard.A1.Flex \
            --subnet-id "$OCI_SUBNET_OCID" \
            --assign-public-ip true \
            --display-name "$OCI_INSTANCE_NAME" \
            --image-id "$OCI_IMAGE_OCID" \
            --instance-options "file://$TEMPL_DIR/instanceOptions.json" \
            --shape-config "file://$TEMPL_DIR/shapeConfig.json" \
            --availability-config "file://$TEMPL_DIR/availabilityConfig.json" \
            --boot-volume-size-in-gbs "$OCI_A1_BOOT_GB" \
            --ssh-authorized-keys-file "$SSH_PUB" 2>&1)
          rc=$?
          set -e
          echo "$launch_output"

          if [ $rc -ne 0 ]; then
            if echo "$launch_output" | grep -q "Out of host capacity"; then
              summary="Out of host capacity for A1 in region $OCI_REGION; will try again on next run."
              echo "$summary"
              echo "result=out-of-capacity" >> "$GITHUB_OUTPUT"
              echo "summary=$summary" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            if echo "$launch_output" | grep -q "LimitExceeded"; then
              summary="Service limit exceeded for A1 in region $OCI_REGION; stopping retries."
              echo "$summary"
              echo "result=limit-exceeded" >> "$GITHUB_OUTPUT"
              echo "summary=$summary" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            summary="Unexpected error launching A1 (rc=$rc). Stopping retries."
            echo "$summary"
            echo "result=error" >> "$GITHUB_OUTPUT"
            echo "summary=$summary" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          instance_id=$(echo "$launch_output" | jq -r '.data.id' || echo "")
          if [ -z "$instance_id" ] || [ "$instance_id" = "null" ]; then
            summary="Launch succeeded but could not parse instance ID."
            echo "$summary"
            echo "result=error" >> "$GITHUB_OUTPUT"
            echo "summary=$summary" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          summary="Successfully launched '$OCI_INSTANCE_NAME' A1 instance (OCID: $instance_id, $OCI_A1_OCPUS OCPUs, $OCI_A1_MEMORY_GB GB RAM, $OCI_A1_BOOT_GB GB boot)."
          echo "$summary"
          echo "result=success" >> "$GITHUB_OUTPUT"
          echo "summary=$summary" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release with run result
        if: steps.main.outputs.result != 'already-exists'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "a1-run-${{ github.run_id }}-${{ steps.main.outputs.result }}"
          name: "OCI A1 run #${{ github.run_number }} - ${{ steps.main.outputs.result }}"
          body: |
            ${{ steps.main.outputs.summary }}
            SSH public key used for this run:
            ${{ steps.main.outputs.ssh_public_key }}

      - name: Queue next check if still out of capacity (with 4h chains)
        if: steps.main.outputs.result == 'out-of-capacity'
        shell: bash
        run: |
          OWNER="rajaprogrammer"
          REPO="cloud-laptop"
          WORKFLOW_FILE="oci-a1-hunter.yml"
          BRANCH="main"

          CHAIN_STARTED_AT="${{ steps.main.outputs.chain_started_at }}"
          NOW=$(date -u +%s)
          ELAPSED=$((NOW - CHAIN_STARTED_AT))
          LIMIT=$((4*60*60))   # 4 hours in seconds

          echo "Current chain started at: $CHAIN_STARTED_AT"
          echo "Elapsed seconds in this chain: $ELAPSED"

          if [ "$ELAPSED" -ge "$LIMIT" ]; then
            echo "Chain reached 4 hours; starting a FRESH chain."
            NEW_STARTED_AT="$NOW"
          else
            echo "Chain under 4 hours; continuing same chain."
            NEW_STARTED_AT="$CHAIN_STARTED_AT"
          fi

          # Optional: enforce a minimum delay between checks:
          # sleep 60

          JSON_PAYLOAD=$(cat <<EOF
          {
            "ref": "$BRANCH",
            "inputs": {
              "started_at": "$NEW_STARTED_AT"
            }
          }
          EOF
          )

          echo "Re-dispatching workflow $WORKFLOW_FILE on $OWNER/$REPO@$BRANCH"
          echo "Payload: $JSON_PAYLOAD"

          curl -s -X POST \
            -H "Authorization: token $GH_PAT" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$OWNER/$REPO/actions/workflows/$WORKFLOW_FILE/dispatches" \
            -d "$JSON_PAYLOAD"
